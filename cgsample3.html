<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>CG3</title>
  <script>
    'use strict'

    // 星形のデータを作る
    const n = 5, r = 0.5
    let position = []
    for (let i = 0; i < n; ++i) {
      const t = 4 * Math.PI * i / n
      const x = r * Math.sin(t)
      const y = r * Math.cos(t)
      position.push(x, y)
    }

    // OpenGL ES のコンテキスト
    let gl

    //
    // シェーダのソースプログラムを読み込んでコンパイルする
    //
    function compileShader(id) {

      // シェーダの種類
      const type = {
        "x-shader/x-vertex": gl.VERTEX_SHADER,
        "x-shader/x-fragment": gl.FRAGMENT_SHADER
      }

      // シェーダのソースプログラムを読み込む
      const element = document.getElementById(id)
      const source = element.text.trim()

      // シェーダのソースプログラムをコンパイルする
      const shader = gl.createShader(type[element.type])
      gl.shaderSource(shader, source)
      gl.compileShader(shader)

      // コンパイルエラーが発生していたらエラーメッセージを表示する
      if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
        console.error(element.type + ':\n' + gl.getShaderInfoLog(shader))
        gl.deleteShader(shader)
        return null
      }

      return shader
    }

    //
    // プログラムオブジェクトを作成する
    //
    function loadShader(vertId, fragId) {

      // バーテックスシェーダをコンパイルする
      const vertShader = compileShader(vertId)

      // フラグメントシェーダをコンパイルする
      const fragShader = compileShader(fragId)

      // エラーが発生していればプログラムオブジェクトを作成しない
      if (!vertShader || !fragShader) return null

      // プログラムオブジェクトを作成する
      const program = gl.createProgram()

      // バーテックスシェーダとフラグメントシェーダをリンクする
      gl.attachShader(program, vertShader)
      gl.deleteShader(vertShader)
      gl.attachShader(program, fragShader)
      gl.deleteShader(fragShader)
      gl.linkProgram(program)

      // リンクエラーが発生していたらエラーメッセージを表示する
      if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
        console.error('Link: ' + gl.getProgramInfoLog(program))
        gl.deleteProgram(program)
        return null
      }

      // 作成されたプログラムオブジェクトを返す
      return program
    }

    //
    // 頂点配列オブジェクトを作成する
    //
    function createObject(position) {

      // 頂点配列オブジェクトを作成して結合する
      const vao = gl.createVertexArray()
      gl.bindVertexArray(vao)

      // 頂点バッファオブジェクトを作成して結合する
      const vbo = gl.createBuffer()
      gl.bindBuffer(gl.ARRAY_BUFFER, vbo)

      // 頂点バッファオブジェクトのメモリを確保してデータを転送する
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(position), gl.STATIC_DRAW)

      // 頂点バッファオブジェクトの先頭を 0 番のインデックスに割り当てる
      gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0)
      gl.enableVertexAttribArray(0)

      // 頂点バッファオブジェクトの結合を解除する
      gl.bindBuffer(gl.ARRAY_BUFFER, null)

      // 頂点配列オブジェクトの結合を解除する
      gl.bindVertexArray(null)

      // 作成した頂点配列オブジェクトと頂点の数を返す
      return { vao: vao, count: Math.floor(position.length / 2) }
    }

    //
    // 描画する
    //
    function draw(object) {

      //カンバス内の表示を消去する
      gl.clear(gl.COLOR_BUFFER_BIT)

      // 描画する頂点配列オブジェクト（図形）を指定する
      gl.bindVertexArray(object.vao)

      // 図形を描画する
      gl.drawArrays(gl.LINE_LOOP, 0, object.count)

      // 頂点配列オブジェクトの指定を解除する
      gl.bindVertexArray(null)
    }
  </script>
  <script id="vertex-shader" type="x-shader/x-vertex">
    #version 300 es
    //
    // バーテックスシェーダのソースプログラム
    //
    precision mediump float;

    layout (location = 0) in vec4 position;

    uniform mat4 m;

    void main()
    {
      gl_Position = m * position;
    }
  </script>
  <script id="fragment-shader" type="x-shader/x-fragment">
    #version 300 es
    //
    // フラグメントシェーダのソースプログラム
    //
    precision mediump float;

    layout (location = 0) out vec4 color;

    void main()
    {
      color = vec4(1.0, 1.0, 0.0, 1.0);
    }
  </script>
</head>

<body>

  <h1>課題 3 (1)</h1>
  <canvas id="CG3-1" width="400" height="300" style="border: inset;">
    HTML5 の canvas が使えません
  </canvas>
  <script>
    {
      const canvas = document.getElementById("CG3-1")
      gl = canvas.getContext('webgl2')

      gl.viewport(0, 0, canvas.width, canvas.height)
      gl.clearColor(0.2, 0.3, 0.4, 1.0)

      const shader = loadShader('vertex-shader', 'fragment-shader')
      const mLoc = gl.getUniformLocation(shader, "m")
      const object = createObject(position)
      gl.useProgram(shader)

      // 課題 3 (1) の図形を描くよう下の変換行列 m を設定してください
      const m = [
        Math.cos(1), 0, Math.sin(1), 0,
        0, 1, 0, 0,
        -1*Math.sin(1), 0, Math.cos(1), 0,
        0, 0, 0, 1
      ]

      gl.uniformMatrix4fv(mLoc, false, m)
      draw(object)
      gl.useProgram(null)
    }
  </script>

<h1>課題 3 (2)</h1>
<canvas id="CG3-2" width="400" height="300" style="border: inset;">
  HTML5 の canvas が使えません
</canvas>
<script>
  {
    const canvas = document.getElementById("CG3-2")
    gl = canvas.getContext('webgl2')

    gl.viewport(0, 0, canvas.width, canvas.height)
    gl.clearColor(0.2, 0.4, 0.3, 1.0)

    const shader = loadShader('vertex-shader', 'fragment-shader')
    const mLoc = gl.getUniformLocation(shader, "m")
    const object = createObject(position)
    gl.useProgram(shader)

    // 課題 3 (2) の図形を描くよう下の変換行列 m を設定してください
    const m = [
      Math.cos(-1 * 20 * Math.PI / 180), -1*Math.sin(-1 * 20 * Math.PI / 180), 0, 0.6,
      Math.sin(-1 * 20 * Math.PI / 180), Math.cos(-1 * 20 * Math.PI / 180), 0, 0.4,
      0, 0, 1, 0,
      0, 0, 0, 1
    ]

    gl.uniformMatrix4fv(mLoc, true, m)
    draw(object)
    gl.useProgram(null)
  }
</script>

<h1>課題 3 (3)</h1>
<canvas id="CG3-3" width="400" height="300" style="border: inset;">
  HTML5 の canvas が使えません
</canvas>
<script>
  {
    const canvas = document.getElementById("CG3-3")
    gl = canvas.getContext('webgl2')

    gl.viewport(0, 0, canvas.width, canvas.height)
    gl.clearColor(0.3, 0.2, 0.4, 1.0)

    const shader = loadShader('vertex-shader', 'fragment-shader')
    const mLoc = gl.getUniformLocation(shader, "m")
    const object = createObject(position)
    gl.useProgram(shader)

    // 課題 3 (3) の図形を描くよう下の変換行列 m を設定してください
    const m = [
      canvas.height/canvas.width, 0, 0, 0,
      0, 1, 0, 0,
      0, 0, 1, 0,
      0, 0, 0, 1
    ]

    gl.uniformMatrix4fv(mLoc, false, m)
    draw(object)
    gl.useProgram(null)
  }
</script>

<h1>課題 3 (4)</h1>
<canvas id="CG3-4" width="400" height="300" style="border: inset;">
  HTML5 の canvas が使えません
</canvas>
<script>
  {
    const canvas = document.getElementById("CG3-4")
    gl = canvas.getContext('webgl2')

    gl.viewport(0, 0, canvas.width, canvas.height)
    gl.clearColor(0.4, 0.3, 0.3, 1.0)

    const shader = loadShader('vertex-shader', 'fragment-shader')
    const mLoc = gl.getUniformLocation(shader, "m")
    const object = createObject(position)
    gl.useProgram(shader)

    // 課題 3 (4) の図形を描くよう下の変換行列 m を設定してください
    const far = -3.0
    const near = -1.0
    const focus = 1 / Math.tan(60 / 2)
    const m = [
    focus/(canvas.width/canvas.height), 0, 0, 0,
      0, focus, 0, 0,
      0, 0, -1*((far+near)/(far-near)), -1*((2*far*near)/(far-near)),
      0, 0, -1, 0
    ]

    gl.uniformMatrix4fv(mLoc, false, m)
    draw(object)
    gl.useProgram(null)
  }
</script>
</body>

</html>